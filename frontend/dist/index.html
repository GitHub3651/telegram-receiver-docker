<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram æ¥ç å¹³å°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        
        /* è´¦å·å¡ç‰‡æ ·å¼ */
        .account-card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 5px solid #667eea; transition: transform 0.2s; }
        .account-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .account-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .account-info { display: flex; align-items: center; gap: 15px; }
        .account-phone { font-size: 20px; font-weight: bold; color: #2d3748; }
        .account-meta { font-size: 12px; color: #718096; }
        .meta-separator { margin: 0 10px; color: #cbd5e0; }
        .meta-date { margin-left: 0; }
        .account-actions { display: flex; gap: 8px; }
        
        /* æ¶ˆæ¯ç›’å­æ ·å¼ */
        .message-box { background: #f7fafc; border-radius: 8px; padding: 0; border: 1px solid #e2e8f0; max-height: 300px; overflow-y: auto; }
        .message-item { padding: 12px 15px; border-bottom: 1px solid #edf2f7; display: flex; flex-direction: column; gap: 5px; transition: background 0.3s; }
        .message-item:last-child { border-bottom: none; }
        .message-item:hover { background: #edf2f7; }
        .message-item.highlight { animation: highlight-pulse 2s ease-out; }
        
        .message-row-top { display: flex; justify-content: space-between; align-items: center; }
        .message-code { font-family: 'Courier New', monospace; font-size: 18px; font-weight: bold; color: #667eea; background: #ebf4ff; padding: 2px 6px; border-radius: 4px; }
        .message-time { font-size: 12px; color: #a0aec0; }
        .message-content { font-size: 14px; color: #4a5568; line-height: 1.5; word-break: break-all; }
        .empty-message { text-align: center; color: #a0aec0; padding: 30px; font-size: 14px; }

        @keyframes highlight-pulse {
            0% { background-color: #fff3cd; }
            100% { background-color: transparent; }
        }

        .btn { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-danger { background: #fc8181; color: white; }
        .btn-danger:hover { background: #f56565; }
        .btn-secondary { background: #cbd5e0; color: #4a5568; }
        .btn-secondary:hover { background: #a0aec0; }
        .btn-success { background: #48bb78; color: white; }
        
        .status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; }
        .status.active { background: #c6f6d5; color: #22543d; }
        .status.error { background: #fed7d7; color: #822727; }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.active { display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; border-radius: 10px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-header { font-size: 24px; margin-bottom: 20px; color: #333; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #666; font-size: 14px; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .form-group input:focus { outline: none; border-color: #667eea; }
        .form-actions { display: flex; gap: 10px; margin-top: 20px; }
        .form-actions button { flex: 1; }
        .alert { padding: 12px; border-radius: 5px; margin-bottom: 15px; }
        .alert-error { background: #fed7d7; color: #c53030; }
        .alert-success { background: #c6f6d5; color: #2f855a; }
        
        /* Toast æ ·å¼ */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
        .toast { background: white; padding: 15px 25px; border-radius: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 10px; display: flex; align-items: center; animation: slideIn 0.3s ease-out; min-width: 300px; }
        .toast.info { border-left: 4px solid #3182ce; }
        .toast.success { border-left: 4px solid #38a169; }
        .toast.error { border-left: 4px solid #e53e3e; }
        .toast.warning { border-left: 4px solid #dd6b20; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        /* å¤´éƒ¨å¤´åƒæ ·å¼ */
        .header-avatar {
            width: 40px;
            height: 40px;
            background: white;
            color: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            text-decoration: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        .header-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header { padding: 20px; }
            .header h1 { font-size: 20px; }
            
            /* åˆ—è¡¨å¤´éƒ¨é€‚é… */
            .section-header { flex-direction: column; align-items: stretch; gap: 15px; }
            .section-header h2 { text-align: center; }
            .section-header button { width: 100%; padding: 12px; font-size: 16px; }

            /* å¡ç‰‡é€‚é… */
            .account-card { padding: 15px; }
            .account-header { flex-direction: column; align-items: flex-start; gap: 15px; }
            
            .account-info { width: 100%; flex-direction: column; align-items: flex-start; gap: 5px; }
            .account-phone { font-size: 18px; }
            .account-meta { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-top: 5px; }
            .meta-separator { display: none; }
            
            /* æŒ‰é’®ç»„é€‚é… - å‚ç›´æ’åˆ— */
            .account-actions { width: 100%; flex-direction: column; gap: 10px; }
            .account-actions .btn { width: 100%; padding: 10px; justify-content: center; }
            
            /* æ¶ˆæ¯åˆ—è¡¨é€‚é… */
            .message-item { padding: 10px; }
            .message-code { font-size: 16px; }
            
            /* æ¨¡æ€æ¡†é€‚é… */
            .modal-content { padding: 20px; }
        }
        
        /* åˆ—è¡¨å¤´éƒ¨æ ·å¼ (æ¡Œé¢ç«¯é»˜è®¤) */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section-header h2 { font-size: 24px; color: #2d3748; margin: 0; }
    </style>
</head>
<body>
    <div id="toast-container" class="toast-container"></div>
    <div class="container">
        <div class="header">
            <div class="header-content" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>ğŸ“± Telegram æ¥ç å¹³å°</h1>
                    <p>è‡ªåŠ¨æ¥æ”¶ Telegram éªŒè¯ç  - åœ¨çº¿ç™»å½•ç®¡ç†</p>
                </div>
                <div class="header-actions">
                    <a href="/profile.html" class="header-avatar" id="header-avatar" title="ä¸ªäººä¸­å¿ƒ">
                        ğŸ‘¤
                    </a>
                </div>
            </div>
        </div>
        
        <div class="card" style="background: transparent; box-shadow: none; padding: 0;">
            <div class="section-header">
                <h2>ğŸ“Š è´¦å·åˆ—è¡¨</h2>
                <button class="btn btn-primary" onclick="openAddAccountModal()">+ æ·»åŠ è´¦å·</button>
            </div>
            <div id="accounts-container">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ è´¦å·æ¨¡æ€æ¡† -->
    <div id="addAccountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ·»åŠ  Telegram è´¦å·</div>
            <div id="modal-alert"></div>
            
            <div id="step1">
                <div class="form-group">
                    <label>æ‰‹æœºå·</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="country-select" style="width: 140px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: white; outline: none;"></select>
                        <input type="text" id="phone-input" placeholder="13800138000" style="flex: 1;" />
                    </div>
                </div>
                <div class="form-actions">
                    <button id="btn-send-code" class="btn btn-primary" onclick="sendCode()">å‘é€éªŒè¯ç </button>
                    <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
                </div>
            </div>
            
            <div id="step2" style="display:none;">
                <div class="form-group">
                    <label>éªŒè¯ç </label>
                    <input type="text" id="code" placeholder="12345" />
                </div>
                <div class="form-group">
                    <label>ä¸¤æ­¥éªŒè¯å¯†ç ï¼ˆå¦‚æœæœ‰ï¼‰</label>
                    <input type="password" id="password" placeholder="ç•™ç©ºå¦‚æœæ²¡æœ‰è®¾ç½®" />
                </div>
                <div class="form-actions">
                    <button id="btn-verify-code" class="btn btn-success" onclick="verifyCode()">ç¡®è®¤ç™»å½•</button>
                    <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login.html';
        }

        // API åŸºç¡€ URL
        const API_BASE = '/api';
        
        // å°è£… fetch è¯·æ±‚ï¼Œè‡ªåŠ¨æ·»åŠ  Token
        const originalFetch = window.fetch;
        window.fetch = async (url, options = {}) => {
            options.headers = options.headers || {};
            if (token) {
                options.headers['Authorization'] = `Bearer ${token}`;
            }
            
            const response = await originalFetch(url, options);
            if (response.status === 401) {
                logout();
            }
            return response;
        };

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }

        // å›½å®¶ä»£ç åˆ—è¡¨ (å¸¸ç”¨å›½å®¶)
        const countryList = [
            "China (ä¸­å›½)|+86", "USA (ç¾å›½)|+1", "Hong Kong (é¦™æ¸¯)|+852", "Taiwan (å°æ¹¾)|+886", 
            "Macau (æ¾³é—¨)|+853", "Japan (æ—¥æœ¬)|+81", "Korea (éŸ©å›½)|+82", "Russia (ä¿„ç½—æ–¯)|+7",
            "UK (è‹±å›½)|+44", "Germany (å¾·å›½)|+49", "France (æ³•å›½)|+33", "Italy (æ„å¤§åˆ©)|+39",
            "Canada (åŠ æ‹¿å¤§)|+1", "Australia (æ¾³æ´²)|+61", "New Zealand (æ–°è¥¿å…°)|+64",
            "Singapore (æ–°åŠ å¡)|+65", "Malaysia (é©¬æ¥è¥¿äºš)|+60", "Thailand (æ³°å›½)|+66", 
            "Vietnam (è¶Šå—)|+84", "Philippines (è²å¾‹å®¾)|+63", "Indonesia (å°å°¼)|+62", 
            "India (å°åº¦)|+91", "Pakistan (å·´åŸºæ–¯å¦)|+92", "Turkey (åœŸè€³å…¶)|+90",
            "Brazil (å·´è¥¿)|+55", "Mexico (å¢¨è¥¿å“¥)|+52", "Argentina (é˜¿æ ¹å»·)|+54",
            "Spain (è¥¿ç­ç‰™)|+34", "Netherlands (è·å…°)|+31", "Sweden (ç‘å…¸)|+46",
            "Switzerland (ç‘å£«)|+41", "Poland (æ³¢å…°)|+48", "Ukraine (ä¹Œå…‹å…°)|+380",
            "South Africa (å—é)|+27", "Egypt (åŸƒåŠ)|+20", "Saudi Arabia (æ²™ç‰¹)|+966", 
            "UAE (é˜¿è”é…‹)|+971", "Israel (ä»¥è‰²åˆ—)|+972", "Iran (ä¼Šæœ—)|+98",
            "Belgium (æ¯”åˆ©æ—¶)|+32", "Austria (å¥¥åœ°åˆ©)|+43", "Norway (æŒªå¨)|+47",
            "Denmark (ä¸¹éº¦)|+45", "Finland (èŠ¬å…°)|+358", "Ireland (çˆ±å°”å…°)|+353", 
            "Portugal (è‘¡è„ç‰™)|+351", "Greece (å¸Œè…Š)|+30", "Czech (æ·å…‹)|+420", 
            "Hungary (åŒˆç‰™åˆ©)|+36", "Romania (ç½—é©¬å°¼äºš)|+40", "Other (å…¶ä»–)|"
        ];

        // åˆå§‹åŒ–å›½å®¶é€‰æ‹©æ¡†
        function initCountrySelect() {
            const select = document.getElementById('country-select');
            if (!select || select.options.length > 0) return;
            
            countryList.forEach(item => {
                const [name, code] = item.split('|');
                const option = document.createElement('option');
                option.value = code;
                option.textContent = code ? `${name} ${code}` : name;
                if (code === '+86') option.selected = true;
                select.appendChild(option);
            });
        }
        
        // è·å–å®Œæ•´æ‰‹æœºå·
        function getFullPhone() {
            const country = document.getElementById('country-select').value;
            const number = document.getElementById('phone-input').value.trim();
            if (!country && !number.startsWith('+')) return ''; // å¦‚æœé€‰äº†"å…¶ä»–"ä¸”æ²¡å¡«+å·ï¼Œå¯èƒ½æœ‰é—®é¢˜ï¼Œä½†è¿™é‡Œç®€å•å¤„ç†
            return (country + ' ' + number).trim();
        }
        
        // æ—¶é—´æ ¼å¼åŒ–å·¥å…·
        const formatTime = (str) => {
            if (!str) return '';
            const dateStr = str.endsWith('Z') ? str : str + 'Z';
            return new Date(dateStr).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', hour12: false });
        };

        // æ˜¾ç¤ºæç¤º
        function showAlert(message, type = 'info') {
            const alertDiv = document.getElementById('modal-alert');
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => { alertDiv.innerHTML = ''; }, 5000);
        }
        
        // æ‰“å¼€æ·»åŠ è´¦å·æ¨¡æ€æ¡†
        function openAddAccountModal() {
            initCountrySelect();
            document.getElementById('addAccountModal').classList.add('active');
            document.getElementById('step1').style.display = 'block';
            document.getElementById('step2').style.display = 'none';
            document.getElementById('phone-input').value = '';
            document.getElementById('country-select').value = '+86';
            document.getElementById('code').value = '';
            document.getElementById('password').value = '';
            document.getElementById('modal-alert').innerHTML = '';
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('addAccountModal').classList.remove('active');
        }
        
        // å‘é€éªŒè¯ç 
        async function sendCode() {
            const phone = getFullPhone();
            if (!phone || phone.length < 5) {
                showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·', 'error');
                return;
            }
            
            const btn = document.getElementById('btn-send-code');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'æ­£åœ¨å‘é€éªŒè¯ç ...';
            btn.style.opacity = '0.7';
            
            try {
                const res = await fetch(`${API_BASE}/accounts/send-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    showAlert('éªŒè¯ç å·²å‘é€ï¼Œè¯·æŸ¥çœ‹ Telegram', 'success');
                    document.getElementById('step1').style.display = 'none';
                    document.getElementById('step2').style.display = 'block';
                } else {
                    const errorMsg = typeof data.detail === 'string' ? data.detail : 
                                    (data.detail?.message || data.message || 'å‘é€å¤±è´¥');
                    showAlert(errorMsg, 'error');
                }
            } catch (e) {
                showAlert('ç½‘ç»œé”™è¯¯: ' + (e.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
                btn.style.opacity = '1';
            }
        }
        
        // éªŒè¯ç™»å½•
        async function verifyCode() {
            const phone = getFullPhone();
            const code = document.getElementById('code').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!code) {
                showAlert('è¯·è¾“å…¥éªŒè¯ç ', 'error');
                return;
            }
            
            const btn = document.getElementById('btn-verify-code');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'æ­£åœ¨ç™»å½•...';
            btn.style.opacity = '0.7';
            
            try {
                const res = await fetch(`${API_BASE}/accounts/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, code, password: password || null })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    showAlert('ç™»å½•æˆåŠŸï¼', 'success');
                    setTimeout(() => {
                        closeModal();
                        loadAccounts();
                    }, 1500);
                } else {
                    const errorMsg = typeof data.detail === 'string' ? data.detail : 
                                    (data.detail?.message || data.message || 'ç™»å½•å¤±è´¥');
                    showAlert(errorMsg, 'error');
                }
            } catch (e) {
                showAlert('ç½‘ç»œé”™è¯¯: ' + (e.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
                btn.style.opacity = '1';
            }
        }
        
        // åˆ é™¤è´¦å·
        async function deleteAccount(id, phone) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è´¦å· ${phone} å—ï¼Ÿ`)) return;
            
            try {
                const res = await fetch(`${API_BASE}/accounts/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    alert('åˆ é™¤æˆåŠŸ');
                    loadAccounts();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (e) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        // æ˜¾ç¤º Toast æç¤º
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = message;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-out forwards';
                setTimeout(() => { toast.remove(); }, 300);
            }, 3000);
        }

        // æ‰‹åŠ¨æ£€æŸ¥éªŒè¯ç 
        async function checkCode(accountId, phone) {
            const cleanPhone = phone.replace(/[^0-9]/g, '');
            const btn = document.getElementById(`btn-check-${cleanPhone}`);
            const originalText = btn.innerText;
            btn.innerText = 'æ£€æŸ¥ä¸­...';
            btn.disabled = true;
            
            try {
                // 1. è§¦å‘åç«¯æ¥æ”¶éªŒè¯ç  (ä½¿ç”¨ accountId)
                const res = await fetch(`${API_BASE}/accounts/check/${accountId}`, { method: 'POST' });
                const data = await res.json();
                
                if (res.ok) {
                    // 2. æ£€æŸ¥æˆåŠŸåï¼Œè·å–è¯¥è´¦å·çš„æœ€æ–°éªŒè¯ç  (ä½¿ç”¨ accountId è·å–)
                    try {
                        const codeRes = await fetch(`${API_BASE}/codes/latest/account/${accountId}`);
                        if (codeRes.ok) {
                            const latestCode = await codeRes.json();
                            // 3. æ›´æ–°è¯¥è´¦å·çš„æ¶ˆæ¯ç›’å­ (å…¨é‡æ£€é‡)
                            updateAccountMessageBox(phone, latestCode);
                        }
                    } catch (ignore) {}

                    if (data.message && data.message.includes('æœªå‘ç°')) {
                        showToast(data.message, 'warning');
                        btn.innerText = 'æ— æ–°ç ';
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-secondary'); 
                    } else {
                        btn.innerText = 'å·²æ›´æ–°';
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-success');
                        showToast('æ£€æŸ¥æˆåŠŸï¼Œå·²æ›´æ–°éªŒè¯ç ', 'success');
                    }
                    
                    setTimeout(() => {
                        btn.innerText = originalText;
                        btn.disabled = false;
                        btn.classList.remove('btn-success');
                        btn.classList.remove('btn-secondary');
                        btn.classList.add('btn-primary');
                    }, 2000);
                } else {
                    showToast('æ£€æŸ¥å¤±è´¥: ' + (data.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                    btn.innerText = originalText;
                    btn.disabled = false;
                    if (res.status === 401) {
                        loadAccounts();
                    }
                }
            } catch (e) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // æ›´æ–°ç‰¹å®šè´¦å·çš„æ¶ˆæ¯ç›’å­ (å…¨é‡æ£€é‡)
        function updateAccountMessageBox(phone, codeData) {
            const cleanPhone = phone.replace(/[^0-9]/g, '');
            const box = document.getElementById(`msg-box-${cleanPhone}`);
            if (!box) return;

            // ç§»é™¤ç©ºçŠ¶æ€
            const emptyMsg = box.querySelector('.empty-message');
            if (emptyMsg) emptyMsg.remove();

            // å…¨é‡æ£€é‡ï¼šéå†æ‰€æœ‰æ¶ˆæ¯é¡¹
            const items = box.querySelectorAll('.message-item');
            const newCode = codeData.code;
            const newTime = formatTime(codeData.received_at);
            
            for (const item of items) {
                const itemCode = item.querySelector('.message-code').innerText;
                const itemTime = item.querySelector('.message-time').innerText;
                
                // å¦‚æœéªŒè¯ç å’Œæ—¶é—´éƒ½åŒ¹é…ï¼Œè®¤ä¸ºæ˜¯åŒä¸€æ¡æ¶ˆæ¯
                if (itemCode === newCode && itemTime === newTime) {
                    // å‘ç°é‡å¤ï¼Œé«˜äº®å¹¶é€€å‡º
                    item.classList.remove('highlight'); // é‡ç½®åŠ¨ç”»
                    void item.offsetWidth; // è§¦å‘é‡ç»˜
                    item.classList.add('highlight');
                    return;
                }
            }

            // å¦‚æœå¾ªç¯ç»“æŸæ²¡å‘ç°é‡å¤ï¼Œåˆ™æ’å…¥æ–°æ¶ˆæ¯
            const newItemHtml = `
                <div class="message-item highlight">
                    <div class="message-row-top">
                        <div class="message-code">${codeData.code}</div>
                        <div class="message-time">${formatTime(codeData.received_at)}</div>
                    </div>
                    <div class="message-content">${codeData.message}</div>
                </div>
            `;
            
            box.insertAdjacentHTML('afterbegin', newItemHtml);
            
            // ç§»é™¤é«˜äº®
            const newItem = box.querySelector('.message-item');
            setTimeout(() => newItem.classList.remove('highlight'), 2000);
        }
        
        // åŠ è½½è´¦å·åˆ—è¡¨ (é‡æ„ä¸ºå¡ç‰‡å¼)
        async function loadAccounts() {
            try {
                const res = await fetch(`${API_BASE}/accounts`);
                const accounts = await res.json();
                const container = document.getElementById('accounts-container');
                
                if (accounts.length === 0) {
                    container.innerHTML = '<div class="empty" style="background:white; padding:40px; border-radius:10px;">æš‚æ— è´¦å·ï¼Œè¯·ç‚¹å‡»"æ·»åŠ è´¦å·"å¼€å§‹</div>';
                    return;
                }
                
                // ç§»é™¤ä¹‹å‰çš„"ä¼˜åŒ–"é€»è¾‘ï¼Œç¡®ä¿æ¯æ¬¡éƒ½æ ¹æ®åç«¯æ•°æ®å…¨é‡æ¸²æŸ“ï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´
                // å…¨é‡æ¸²æŸ“
                let html = '';
                for (const acc of accounts) {
                    const cleanPhone = acc.phone.replace(/[^0-9]/g, '');
                    
                    // è·å–è¯¥è´¦å·çš„å†å²æ¶ˆæ¯ (ä½¿ç”¨ account_id)
                    let messagesHtml = '<div class="empty-message">åŠ è½½æ¶ˆæ¯ä¸­...</div>';
                    try {
                        const msgRes = await fetch(`${API_BASE}/codes?account_id=${acc.id}&limit=20`);
                        const messages = await msgRes.json();
                        if (messages.length > 0) {
                            messagesHtml = messages.map(msg => `
                                <div class="message-item">
                                    <div class="message-row-top">
                                        <div class="message-code">${msg.code}</div>
                                        <div class="message-time">${formatTime(msg.received_at)}</div>
                                    </div>
                                    <div class="message-content">${msg.message}</div>
                                </div>
                            `).join('');
                        } else {
                            messagesHtml = '<div class="empty-message">æš‚æ— éªŒè¯ç æ¶ˆæ¯</div>';
                        }
                    } catch (e) {
                        messagesHtml = '<div class="empty-message">æ¶ˆæ¯åŠ è½½å¤±è´¥</div>';
                    }

                    html += `
                        <div class="account-card" id="card-${cleanPhone}">
                            <div class="account-header">
                                <div class="account-info">
                                    <span class="account-phone">${acc.phone}</span>
                                    <div class="account-meta">
                                        ${acc.is_active 
                                            ? '<span class="status active">æ´»è·ƒ</span>' 
                                            : '<span class="status error">Sessionå¤±æ•ˆ</span>'}
                                        <span class="meta-separator">|</span>
                                        <span class="meta-date">æ·»åŠ äº ${formatTime(acc.created_at).split(' ')[0]}</span>
                                    </div>
                                </div>
                                <div class="account-actions">
                                    <button id="btn-check-${cleanPhone}" class="btn btn-primary" onclick="checkCode(${acc.id}, '${acc.phone}')">æ£€æŸ¥éªŒè¯ç </button>
                                    <button class="btn btn-secondary" onclick="clearAccountCodes(${acc.id}, '${acc.phone}')">æ¸…ç©ºæ¶ˆæ¯</button>
                                    <button class="btn btn-danger" onclick="deleteAccount(${acc.id}, '${acc.phone}')">åˆ é™¤è´¦å·</button>
                                </div>
                            </div>
                            <div class="message-box" id="msg-box-${cleanPhone}">
                                ${messagesHtml}
                            </div>
                        </div>
                    `;
                }
                container.innerHTML = html;
            } catch (e) {
                console.error(e);
                document.getElementById('accounts-container').innerHTML = '<div class="empty">åŠ è½½å¤±è´¥</div>';
            }
        }
        
        // æ¸…ç©ºç‰¹å®šè´¦å·çš„æ¶ˆæ¯
        async function clearAccountCodes(accountId, phone) {
            if (!confirm(`ç¡®å®šè¦æ¸…ç©º ${phone} çš„æ‰€æœ‰éªŒè¯ç è®°å½•å—ï¼Ÿ`)) return;
            
            try {
                const res = await fetch(`${API_BASE}/codes?account_id=${accountId}`, { method: 'DELETE' });
                
                if (res.ok) {
                    showToast('æ¶ˆæ¯å·²æ¸…ç©º', 'success');
                    const cleanPhone = phone.replace(/[^0-9]/g, '');
                    const box = document.getElementById(`msg-box-${cleanPhone}`);
                    if (box) {
                        box.innerHTML = '<div class="empty-message">æš‚æ— éªŒè¯ç æ¶ˆæ¯</div>';
                    }
                } else {
                    showToast('æ¸…ç©ºå¤±è´¥', 'error');
                }
            } catch (e) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨äºå¤´åƒï¼‰
        async function loadUserInfo() {
            try {
                const res = await fetch(`${API_BASE}/auth/me`);
                if (res.ok) {
                    const user = await res.json();
                    const letter = user.email.charAt(0).toUpperCase();
                    document.getElementById('header-avatar').textContent = letter;
                }
            } catch (e) {
                console.error('Failed to load user info', e);
            }
        }

        // åˆå§‹åŠ è½½
        loadUserInfo();
        loadAccounts();
        
        // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°çŠ¶æ€ (ä¸å†åˆ·æ–°æ•´ä¸ªåˆ—è¡¨)
        setInterval(() => {
            loadAccounts();
        }, 30000);
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('addAccountModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
    </script>
</body>
</html>
